<!-- create-exercice.component.html -->
<div class="form-wrapper">
  <app-top-nav-bar [showBackToUsers]="true" class="top-nav-bar-creation"></app-top-nav-bar>
  <div class="form-card">
    <h2>
      <i class="fas fa-plus-circle"></i>
      Cr√©ons un exercice amusant
    </h2>

    <form (ngSubmit)="onSubmit()">
      <!-- √âtape 1 : Cat√©gories -->
      <div *ngIf="currentStep === 1" class="step-1" data-testid="step-1">
        <div class="form-group">
          <label for="theme">Th√®me de l'exercice</label>
          <input
            type="text"
            id="theme"
            name="theme"
            [(ngModel)]="exercice.theme"
            placeholder="Ex : Objets et pi√®ces de la maison"
            required
          />
        </div>

        <div *ngIf="exercice.theme === 'autre'" class="form-group">
          <label for="customTheme">Votre th√®me personnalis√©</label>
          <input type="text" id="customTheme" name="customTheme" [(ngModel)]="customTheme" placeholder="Entrez un th√®me..." required />
        </div>

        <div class="form-group">
          <label for="name">Nom amusant de l'exercice</label>
          <input type="text" id="name" name="name" [(ngModel)]="exercice.name" placeholder="Ex: Rangeons notre maison !" required />
        </div>

        <div class="form-group">
          <label for="description">Description (optionnelle)</label>
          <textarea id="description" name="description" [(ngModel)]="exercice.description"
                    placeholder="D√©crivez bri√®vement l'objectif de cet exercice..."></textarea>
        </div>

        <div class="form-group">
          <label>Ajouter une cat√©gorie</label>
          <div class="category-form">
            <input type="text" name="categoryName" [(ngModel)]="categoryInput.name" placeholder="Nom de la cat√©gorie (ex: Cuisine)" data-testid="category-name-input" />
            <input type="text" name="categoryDescription" [(ngModel)]="categoryInput.description" placeholder="Description (ex: Pi√®ce o√π l'on pr√©pare √† manger)" data-testid="category-description-input" />
            <div class="btn-add-picture">
              <input type="file" name="categoryImage" (change)="onCategoryImageSelected($event)" data-testid="category-image-input" />
              <div *ngIf="categoryInput.imagePath" class="image-ok">‚úÖ Image ajout√©e</div>
            </div>
          </div>

          <button type="button" class="btn-add" (click)="addCategory()"
                  [disabled]="!categoryInput.name || !categoryInput.description || !categoryInput.imagePath || exercice.categories.length >= 3"
                  data-testid="add-category-button">
            <i class="fas fa-plus"></i> Ajouter cette cat√©gorie
          </button>

          <div *ngIf="exercice.categories.length > 0" class="added-section">
            <h4>Cat√©gories ajout√©es:</h4>
            <ul>
              <li *ngFor="let category of exercice.categories; let i = index" class="category-item" [attr.data-testid]="'category-item-' + i">
                <span>üì∑ <strong>{{ category.name }}</strong> - {{ category.description }}</span>
                <button class="btn-remove" (click)="removeCategory(i)" [attr.data-testid]="'remove-category-' + i">
                      <i class="fas fa-trash-alt"></i> Supprimer
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- √âtape 2 : Items -->
      <div *ngIf="currentStep === 2" class="step-2" data-testid="step-2">
        <div class="form-group">
          <label>Ajouter des objets √† placer</label>

          <div class="item-box">
            <input type="text" name="itemName" [(ngModel)]="itemInput.name" placeholder="Nom de l'objet (ex: Fourchette)" data-testid="item-name-input" />
            <input type="text" name="itemDescription" [(ngModel)]="itemInput.description" placeholder="Description (ex: Ustensile pour manger)" data-testid="item-description-input" />
            <div class="btn-add-picture">
              <input type="file" name="itemImage" (change)="onItemImageSelected($event)" data-testid="item-image-input" />
            </div>
            <select name="itemCategory" [(ngModel)]="itemInput.category" data-testid="item-category-select">
              <option value="">-- S√©lectionner la cat√©gorie de cet objet --</option>
              <option *ngFor="let category of exercice.categories" [value]="category.name">
                {{ category.name }}
              </option>
            </select>
          </div>

          <button type="button" class="btn-add" (click)="addItem()"
                  [disabled]=" !itemInput.name|| !itemInput.description.trim() || !itemInput.imagePath || !itemInput.category "
                  data-testid="add-item-button">
            Ajouter cet objet
          </button>

          <div *ngIf="exercice.items.length > 0" class="added-section">
            <h4>Objets ajout√©s:</h4>
            <ul>
              <li *ngFor="let item of exercice.items; let i = index" class="item-list" [attr.data-testid]="'item-list-' + i">
                <span>üß© <strong>{{ item.name }}</strong> - {{ item.description }} (Cat√©gorie: {{ item.category }})</span>
                    <button class="btn-remove" (click)="removeItem(i)" [attr.data-testid]="'remove-item-' + i">
                      <i class="fas fa-trash-alt"></i> Supprimer
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>

       <!-- √âtape 3 : Validation -->
      <div *ngIf="currentStep === 3" class="step-3" data-testid="step-3">
        <h3>Validation finale</h3>
        <p><strong>Nom :</strong> {{ exercice.name }}</p>
        <p><strong>Th√®me :</strong> {{ exercice.theme === 'autre' ? customTheme : exercice.theme }}</p>
        <p><strong>Description :</strong> {{ exercice.description }}</p>
        
        <div class="validation-summary">
          <h4>R√©sum√© de l'exercice:</h4>
          <div class="categories-summary">
            <h5>Cat√©gories ({{ exercice.categories.length }}):</h5>
            <ul>
              <li *ngFor="let category of exercice.categories">
                <strong>{{ category.name }}</strong> - {{ category.description }}
                <span class="item-count">({{ getItemsInCategory(category.name).length }} objets)</span>
              </li>
            </ul>
          </div>
          
          <div class="items-summary">
            <h5>Objets ({{ exercice.items.length }}):</h5>
            <ul>
              <li *ngFor="let item of exercice.items">
                <strong>{{ item.name }}</strong> - {{ item.description }} 
                <em>({{ item.category }})</em>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="navigation-buttons">
        <button type="button" (click)="prevStep()" [disabled]="currentStep === 1" data-testid="previous-button">Pr√©c√©dent</button>
        <button type="button" (click)="nextStep()" *ngIf="currentStep < 3"
          [disabled]="(currentStep === 1 && exercice.categories.length === 0) || (currentStep === 2 && exercice.items.length === 0)"
          data-testid="next-button">
          Suivant
        </button>
        <button type="submit" *ngIf="currentStep === 3"
                [disabled]="!exercice.name || !getFinalTheme() || exercice.categories.length === 0"
                data-testid="submit-button">
          Cr√©er l'exercice
        </button>
      </div>
    </form>

    <div class="success-message" *ngIf="exerciceCreated" data-testid="success-message">
      L'exercice a √©t√© cr√©√© avec succ√®s !
    </div>
  </div>
  <app-top-nav-bar [showBackToExercices]="true" class="top-nav-bar-creation"></app-top-nav-bar>
</div>