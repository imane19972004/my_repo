<div class="user-history">
  <h2>Détails de l'utilisateur</h2>

  <div *ngIf="user">
    <p><strong>Nom :</strong> {{ user.firstName }} {{ user.lastName }}</p>
    <p><strong>Âge :</strong> {{ user.age }} ans</p>
    <p><strong>Particularité :</strong> {{ user.particularity }}</p>
    <p><strong>Rôle :</strong> {{ user.role }}</p>
  </div>

  <hr>

  <h2>Historique de l'utilisateur</h2>

  <div *ngIf="user?.role?.startsWith('Encadrant')">
    <p>Pas d'historique pour les encadrants.</p>
  </div>

  <div *ngIf="loading && user?.role?.startsWith('Accueilli')">
    <p>Chargement de l'historique...</p>
  </div>

  <div *ngIf="!loading && filteredExerciseHistories.length === 0">
    <p>Aucun exercice joué pour cet utilisateur.</p>
  </div>

  <div *ngFor="let exerciceId of objectKeys(groupedHistory)" class="exercise-block">
    <h3>{{ groupedHistory[exerciceId][0].exerciceName }}</h3>

    <!-- Graphique global exercice -->
    <canvas #exerciseCanvas></canvas>

    <!-- Dernière tentative -->
    <div class="card">
      <p><strong>Dernière tentative :</strong></p>
      <p>Objets bien placés : {{ getLatestAttempt(exerciceId).success }}</p>
      <p>Nombre de mauvais placements : {{ getLatestAttempt(exerciceId).failure }}</p>
    </div>

    <!-- Erreurs par objet pour la dernière tentative -->
    <div class="card" *ngIf="getLatestAttempt(exerciceId).itemFailures">
      <h4><strong>Erreurs par objet</strong> (dernière tentative) :</h4>
      <ul>
        <p>Sélectionnez un objet pour voir son historique</p>
        <li *ngFor="let item of getAllItemNames(exerciceId)">
          <button (click)="showItemGraph(exerciceId, item, $event)">
            {{ item }} : {{ getLatestItemFailureCount(exerciceId, item) }} erreur(s)
          </button>
        </li>
      </ul>
    </div>

    <!-- Graphique spécifique à un objet -->
    <div *ngIf="selectedItem && selectedExerciseId === exerciceId">
      <h4>Historique pour l'objet : {{ selectedItem }}</h4>
      <canvas #itemCanvas></canvas>
    </div>
  </div>
</div>
